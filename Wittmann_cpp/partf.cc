#include<stdio.h>
#include<string.h>
#include<math.h>
#include<iostream>

#include "atom.h"


void atom::partf(int na,double T,double N)
{

  double x=log(5040./T);
  double dx=-1./T;
  double y=1.E-3*T;

  int elm = Z[na];

  double * u = new double[nion[na]];
  for (int ee =0;ee<nion[na];ee++)
    u[ee] = 0.0;

  double lgT = log(T);
  double invT = 1.0/T;

  /* partition function for each element and their derivatives */
  if(elm==1)
  { 
    /* Irwin 1981 */
    /*
      u[0]=exp(-2.61655891E+02+lgT*(1.63428326E+02+lgT*(-4.06133526E+01+lgT*(5.03282928E+00
      + lgT*(-3.10998364E-01 + lgT*7.66654594E-03)))));
     
      if(T>=16000)
      u[0]=exp(7.19420558e-1); */
    /* Original Wittmann
     *
     * if (T < 1.3e4)
     * u[0] = 2.0;
     * else if (T < 1.62e4)
     * u[0]=1.51+3.8e-5*T;
     * else
     * u[0] = 11.41 + T*(-1.1428e-3+T*3.52e-8); */

     /* Cardona 2010 */
    /*Ground State */
    
    double Z_eff = 1.0;
    double qq = sqrt(Z_eff/2.0/PI/a0)/pow(N,1.0/6.0);
    double nstar = qq/2.0*(1.0+sqrt(1.0+4.0/qq));
    nstar = nstar>7.0?nstar:7.0;
    double Ehat_njk = (chi[na][1]*ev-Z_eff*Z_eff*Ry/nstar/nstar)/k;

    /* fprintf(stdout,"Hydrogen: nion %d Z_eff %e nstar %e G0 %e E0 %e Gjk %e epsjk %e m %e chi %e \n", nion[na], Z_eff, nstar, G0[na][1], E0[na][1]*k/ev, Gjk[na][1], epsjk[na][1]*k/ev/1.2398e-4, m[na][1],chi[na][1]); */

    u[0] = G0[na][1]*exp(-E0[na][1]*invT) + Gjk[na][1]*exp(-epsjk[na][1]*invT)+m[na][1]/3.0*(pow(nstar,3.0)-343.0)*exp(-Ehat_njk*invT);
    u[1]=1.0;
  }
  if(elm==2)
  {
/*
    if (T < 3.e4)
      u[0] = 1.0;
    else
      u[0] = 14.8 + T*(-9.4103e-4+T*1.6095e-8);

    u[1] = 2.0; */

    /* Irwin 1981  */
   /*  u[0]=exp(-3.76575219E-01+lgT*(2.33951687E-01+lgT*(-5.79755525E-02+lgT*(7.16333160E-03
     +lgT*(-4.41302573E-04 + lgT*1.08442097E-05)))));
    
     if(T>=16000)
     u[0]=exp(2.93217958e-5);
    
     u[1]=exp(6.93147179E-01+lgT*(9.29636701E-10+lgT*(-2.30049742E-10+lgT*(2.83829746E-11
     +lgT*(-1.74590774E-12 + lgT*4.28355287E-14)))));
    
     if(T>=16000)
     u[1]=exp(6.93147180e-1);
    */ 
    /* Cardona 2010 */
    /*Ground State */
    
    double Z_eff = 1.0;
    double qq = sqrt(Z_eff/2.0/PI/a0)/pow(N,1.0/6.0);
    double nstar = qq/2.0*(1.0+sqrt(1.0+4.0/qq));
    nstar = nstar>7.0?nstar:7.0;
    double Ehat_njk = (chi[na][1]*ev-Z_eff*Z_eff*Ry/nstar/nstar)/k;
    u[0] = G0[na][1]*exp(-E0[na][1]*invT) + Gjk[na][1]*exp(-epsjk[na][1]*invT)+m[na][1]/3.0*(pow(nstar,3.0)-343.0)*exp(-Ehat_njk*invT);
    /* fprintf(stdout,"Helium lvl 1: nion %d Z_eff %e nstar %e G0 %e E0 %e Gjk %e epsjk %e m %e chi %e \n", nion[na],Z_eff, nstar, G0[na][1], E0[na][1]*k/ev, Gjk[na][1], epsjk[na][1]*k/ev/1.2398e-4, m[na][1],chi[na][1]); */
    /* Cardona 2010 */
    /* First Excited State */
    
    Z_eff = 2.0;

    qq = sqrt(Z_eff/2.0/PI/a0)/pow(N,1.0/6.0);
    nstar = qq/2.0*(1.0+sqrt(1.0+4.0/qq));
    nstar = nstar>7.0?nstar:7.0;

    Ehat_njk = (chi[na][2]*ev-Z_eff*Z_eff*Ry/nstar/nstar)/k;
    u[1] = G0[na][2]*exp(-E0[na][2]*invT) + Gjk[na][2]*exp(-epsjk[na][2]*invT)+m[na][2]/3.0*(pow(nstar,3.0)-343.0)*exp(-Ehat_njk*invT);
    
    u[2] =1.0;
    /* fprintf(stdout,"Helium lvl 2: Z_eff %e nstar %e G0 %e E0 %e Gjk %e epsjk %e m %e chi %e \n", Z_eff, nstar, G0[na][2], E0[na][2]*k/ev, Gjk[na][2], epsjk[na][2]*k/ev/1.2398e-4, m[na][2],chi[na][2]); */
  }
  if(elm==3){
    u[0]=2.081-y*(6.8926E-2-y*1.4081E-2);
    if(T>6E3){
      u[0]=3.4864+T*(-7.3292E-4+T*8.5586E-8);
    }
    u[1]=1.0000;
    u[2]=2.00000;
  }
  if(elm==4)
  {
    double aa=1.0;
    double bb=.631+7.032E-5*T;
    u[0]=aa>bb?aa:bb;
    u[1]=2.00;
    u[2]=1.000;
  }
  if(elm==5){
    u[0]=5.9351+1.0438E-2*y;
    u[1]=1.00;
    u[2]=2.0;
  }
  if(elm==6)
  {
    u[0]=8.6985+y*(2.0485E-2+y*(1.7629E-2-3.9091E-4*y));
    if(T>1.2E4)
      u[0]=13.97+T*(-1.3907E-3+T*9.0844E-8);
    u[1]=5.838+1.6833E-5*T;
    if(T>2.4E4)
      u[1]=10.989+T*(-6.9347E-4+T*2.0861E-8);
    u[2]=1.00;
    if(T>1.95E4)
      u[2]=-0.555+8E-5*T;

    /* Irwin 1981 
     * u[0]=exp(9.21720021e0+lgT*(-6.57474804e0+lgT*(2.04630537e0+lgT*(-2.86334470e-1
     * +lgT*(1.83809654e-2 + lgT*-4.29672351e-4)))));
     *
     * if(T>=16000)
     * u[0]=exp(2.46973443e0);
     *
     * u[1]=exp(-1.85578951e2+lgT*(1.16815901e2+lgT*(-2.91473937e1+lgT*(3.63531100e0
     * +lgT*(-2.26513357e-1 + lgT*5.63890268e-3)))));
     *
     * if(T>=16000)
     * u[1]=exp(1.82927003e0);
     *
     * u[2]=exp(-1.46432100e1+lgT*(6.83101919e0+lgT*(-1.24907508e0+lgT*(1.41406855e-1
     * +lgT*(-9.94709007e-3 + lgT*3.16570356e-4)))));
     *
     * if(T>=16000)
     * u[2]=exp(7.17315029e-2); */
  }
  if(elm==7)
  {
    u[0]=3.9914+y*(1.7491E-2-y*(1.0148E-2-y*1.7138E-3));
    if(T>8800.)
      u[0]=2.171+2.54E-4*T;
    if(T>1.8E4)
      u[0]=11.396+T*(-1.7139E-3+T*8.633E-8);
    u[1]=8.060+1.420E-4*T;
    if(T>3.3E4)
      u[1]=26.793+T*(-1.8931E-3+T*4.4612E-8);
    u[2]=5.9835+T*(-2.6651E-5+T*1.8228E-9);
    if(T<7310.5)
      u[2]=5.89;

    /* Irwin 1981 
     * u[0]=exp(2.88717295e2+lgT*(-1.68872285e2+lgT*(3.91254756e1+lgT*(-4.45059341e0
     * +lgT*(2.47223728e-1 + lgT*-5.31945494e-3)))));
     *
     * if(T>=16000)
     * u[0]=exp(1.87112181e0);
     *
     * u[1]=exp(1.28777940e2+lgT*(-7.95497944e1+lgT*(1.96686627e1+lgT*(-2.39615935e0
     * +lgT*(1.43891814e-1 + lgT*-3.40476068e-3)))));
     *
     * if(T>=16000)
     * u[1]=exp(2.34003850e0);
     *
     * u[2]=exp(-8.61956970e1+lgT*(5.22049927e1+lgT*(-1.25274613e1+lgT*(1.51416152e0
     * +lgT*(-9.19393680e-2 + lgT*2.23943277e-3)))));
     *
     * if(T>=16000)
     * u[2]=exp(1.79218023e0); */

  }
  if(elm==8){

    u[0]=8.29+1.10E-4*T;
    if(T>1.9E4)
      u[0]=66.81+T*(-6.019E-3+T*1.657E-7);
    double aa=4.0;
    double bb=3.51+8.E-5*T;
    u[1]=aa>bb?aa:bb;
    if(T>3.64E4)
      u[1]=68.7+T*(-4.216E-3+T*6.885E-8);
    u[2]=7.865+1.1348E-4*T;

    /* Irwin 1981 
     * u[0]=exp(-6.26219795e0+lgT*(5.12651680e0+lgT*(-1.44691306e0+lgT*(2.23196759e-1
     * +lgT*(-1.78196943e-2 + lgT*5.71458469e-4)))));
     *
     * if(T>=16000)
     * u[0]=exp(2.34142592);
     *
     * u[1]=exp(-1.11049302e2+lgT*(7.83028959e1+lgT*(-2.16736253e1+lgT*(2.98204280e0
     * +lgT*(-2.04044209e-1 + lgT*5.55676601e-3)))));
     *
     * if(T>=16000)
     * u[1]=exp(1.62465674);
     *
     * u[2]=exp(-1.46432100e1+lgT*(6.83101919e0+lgT*(-1.24907508e0+lgT*(1.41406855e-1
     * +lgT*(-9.94709007e-3 + lgT*3.16570356e-4)))));
     *
     * if(T>=16000)
     * u[2]=exp(2.27096875); */
  }
  if(elm==9){
    u[0]=4.5832+y*(.77683+y*(-.20884+y*(2.6771E-2-1.3035E-3*y)));
    if(T>8750.){
      u[0]=5.9;
    }
    if(T>2E4){
      u[0]=15.16+T*(-9.229E-4+T*2.312E-8);
    }
    u[1]=8.15+8.9E-5*T;
    u[2]=2.315+1.38E-4*T;
  }
  if(elm==10){

    u[0]=1.0000;
    if(T>2.69E4)
      u[0]=26.3+T*(-2.113E-3+T*4.359E-8);

    u[1]=5.4+4.E-5*T;
    u[2]=7.973+7.956E-5*T;

    /* Irwin 1981 
     * u[0]=exp(-9.89746326e0+lgT*(6.15156332e0+lgT*(-1.52510257e0+lgT*(1.88526264e-1
     * +lgT*(-1.16199387e-2 + lgT*2.85685024e-4)))));
     *
     * if(T>=16000)
     * u[0]=exp(8.02995289e-4);
     *
     * u[1]=exp(4.24370369e1+lgT*(-2.54522643e1+lgT*(6.16021294e0+lgT*(-7.30334327e-1
     * +lgT*(4.27298061e-2 + lgT*-9.91258327e-4)))));
     *
     * if(T>=16000)
     * u[1]=exp(1.76886243e0);
     *
     * u[2]=exp(1.61133431e1+lgT*(-7.89461982e0+lgT*(1.43805082e0+lgT*(-8.81795471e-2
     * +lgT*(-1.09787263e-3 + lgT*2.04771258e-4)))));
     *
     * if(T>=16000)
     * u[2]=exp(2.22437735e0); */

  }
  if(elm==11){
    double aa=2.0;
    double bb=1.72+9.3E-5*T;
    u[0]=aa>bb?aa:bb;
    if(T>5400.){
      u[0]=-0.83+5.66E-4*T;
    }
    if(T>8.5E3){
      u[0]=4.5568+T*(-1.2415E-3+T*1.3861E-7);
    }
    u[1]=1.000;
    u[2]=5.69+5.69E-6*T;
  }
  if(elm==12){
    u[0]=1.+exp(-4.027262-x*(6.173172+x*(2.889176+x*(2.393895+.784131*x))));
    if(T>8E3){
      u[0]=2.757+T*(-7.8909E-4+T*7.4531E-8);
    }
    u[1]=2.+exp(-7.721172-x*(7.600678+x*(1.966097+.212417*x)));
    if(T>2E4){
      u[1]=7.1041+T*(-1.0817E-3+T*4.7841E-8);
    }
    u[2]=1.0000;
  }
  if(elm==13){
    u[0]=5.2955+y*(.27833-y*(4.7529E-2-y*3.0199E-3));
    double aa=1.0;
    double bb=.725+3.245E-5*T;
    u[1]=aa>bb?aa:bb;
    if(T>2.24E4){
      u[1]=61.06+T*(-5.987E-3+T*1.485E-7);
    }
    aa=2.0;
    bb=1.976+3.43E-6*T;  
    u[2]=aa>bb?aa:bb;
    if(T>1.814E4){
      u[2]=3.522+T*(-1.59E-4+T*4.382E-9);
    }
  }
  if(elm==14){
    u[0]=6.7868+y*(.86319+y*(-.11622+y*(.013109-6.2013E-4*y)));
    if(T>1.04E4){
      u[0]=86.01+T*(-1.465E-2+T*7.282E-7);
    }
    u[1]=5.470+4.E-5*T;
    if(T>1.8E4){
      u[1]=26.44+T*(-2.22E-3+T*6.188E-8);
    }
    double aa=1.;
    double bb=.911+1.1E-5*T;
    u[2]=aa>bb?aa:bb;
    if(T>3.33E4){
      u[2]=19.14+T*(-1.408E-3+T*2.617E-8);
    }
  }
  if(elm==15){
    u[0]=4.2251+y*(-.22476+y*(.057306-y*1.0381E-3));
    if(T>6.E3){
      u[0]=1.56+5.2E-4*T;
    }
    u[1]=4.4151+y*(2.2494+y*(-.55371+y*(.071913-y*3.5156E-3)));
    if(T>7250.){
      u[1]=4.62+5.38E-4*T;
    }
    u[2]=5.595+3.4E-5*T;
  }
  if(elm==16){
    u[0]=7.5+2.15E-4*T;
    if(T>1.16E4){
      u[0]=38.76+T*(-4.906E-3+T*2.125E-7);
    }
    u[1]=2.845+2.43E-4*T;
    if(T>1.05E4){
      u[1]=6.406+T*(-1.68E-4+T*1.323E-8);
    }
    u[2]=7.38+1.88E-4*T;
  }
  if(elm==17){
    u[0]=5.2+6.E-5*T;
    if(T>1.84E4){
      u[0]=-81.6+4.8E-3*T;
    }
    u[1]=7.0+2.43E-4*T;
    u[2]=2.2+2.62E-4*T;
  }
  if(elm==18){
    u[0]=1.000;
    u[1]=5.20+3.8E-5*T;
    u[2]=7.474+1.554E-4*T;
  }
  if(elm==19){
    u[0]=1.9909+y*(.023169-y*(.017432-y*4.0938E-3));
    if(T>5800.){
      u[0]=-9.93+2.124E-3*T;
    }
    u[1]=1.000;
    u[2]=5.304+1.93E-5*T;
  }
  if(elm==20){
    u[0]=1.+exp(-1.731273-x*(5.004556+x*(1.645456+x*(1.326861+.508553*x))));
    u[1]=2.+exp(-1.582112-x*(3.996089+x*(1.890737+.539672*x)));
    u[2]=1.000;
  }
  if(elm==21){
    u[0]=4.+exp(2.071563+x*(-1.2392+x*(1.173504+.517796*x)));
    u[1]=3.+exp(2.988362+x*(-.596238+.054658*x));
    u[2]=10.; // APPROxIMATELy
  }
  if(elm==22){
    u[0]=5.+exp(3.200453+x*(-1.227798+x*(.799613+.278963*x)));
    if(T<5.5E3){
      u[0]=16.37+T*(-2.838E-4+T*5.819E-7);
    }
    u[1]=4.+exp(3.94529+x*(-.551431+.115693*x));
    u[2]=16.4+8.5E-4*T;
  }
  if(elm==23){
    u[0]=4.+exp(3.769611+x*(-.906352+x*(.724694+.1622*x)));
    u[1]=1.+exp(3.755917+x*(-.757371+.21043*x));
    u[2]=-18.+1.03E-2*T;
    if(T<2.25E3){
      u[2]=2.4E-3*T;
    }
  }
  if(elm==24){
    u[0]=7.+exp(1.225042+x*(-2.923459+x*(.154709+.09527*x)));
    u[1]=6.+exp(.128752-x*(4.143973+x*(1.096548+.230073*x)));
    u[2]=10.4+2.1E-3*T;
  }
  if(elm==25){
    u[0]=6.+exp(-.86963-x*(5.531252+x*(2.13632+x*(1.061055+.265557*x))));
    u[1]=7.+exp(-.282961-x*(3.77279+x*(.814675+.159822*x)));
    u[2]=10.; //APPROxIMATELy
  }
  if(elm==26){
    u[0]=9.+exp(2.930047+x*(-.979745+x*(.76027+.118218*x)));
    if(T<4E3){
      u[0]=15.85+T*(1.306E-3+T*2.04E-7);
    }
    if(T>9E3){
      u[0]=39.149+T*(-9.5922E-3+T*1.2477E-6);
    }
    u[1]=10.+exp(3.501597+x*(-.612094+.280982*x));
    if(T>1.8E4){
      u[1]=68.356+T*(-6.1104E-3+T*5.1567E-7);
    }
    u[2]=17.336+T*(5.5048E-4+T*5.7514E-8);
  }
  if(elm==27){
    u[0]=8.65+4.9E-3*T;
    u[1]=11.2+3.58E-3*T;
    u[2]=15.0+1.42E-3*T;
  }
  if(elm==28){
    u[0]=9.+exp(3.084552+x*(-.401323+x*(.077498-.278468*x)));
    u[1]=6.+exp(1.593047-x*(1.528966+.115654*x));
    u[2]=13.3+6.9E-4*T;
  }
  if(elm==29){
    double aa=2.;
    double bb=1.50+1.51E-4*T;
    u[0]=aa>bb?aa:bb;
    if(T>6250.){
      u[0]=-.3+4.58E-4*T;
    }
    aa=1.;
    bb=.22+1.49E-4*T;
    u[1]=aa>bb?aa:bb;
    u[2]=8.025+9.4E-5*T;
  }
  if(elm==30){
    double aa=1.;
    double bb=.632+5.11E-5*T;
    u[0]=aa>bb?aa:bb;
    u[1]=2.00;
    u[2]=1.00;
  }

  for (int ee=0;ee<nion[na];ee++)
  {
    uu[na][ee]=u[ee];
  }

  delete [] u;
}
